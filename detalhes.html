<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Dividendo - Alpha Vantage</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  header { background:#000; color:#fff; padding:16px; text-align:center; position: relative; font-size:1.2em; }
  #menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
  #searchContainer { text-align:center; margin:20px; }
  #searchInput { padding:8px; font-size:1em; width:200px; }
  #cards { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:20px; }
  .card { background:#000; color:#fff; padding:16px 24px; border-radius:12px; min-width:140px; text-align:center; }
  .card.wide { min-width:300px; font-size:1.1em; }
  #historyChart { max-width:800px; margin:20px auto; background:#fff; border-radius:12px; padding:16px; }
  footer { text-align:center; padding:16px; background:#000; color:#fff; margin-top:20px; }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span>
  Meu Dividendo - Alpha Vantage
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o código do ativo (ex: PETR4.SA)">
  <button onclick="buscarAtivo()">Buscar</button>
  <p style="font-size:0.9em; color:#555; margin-top:8px;">
    Para ações brasileiras, use o sufixo <strong>.SA</strong>.
  </p>
</div>

<div id="cards"></div>
<canvas id="historyChart"></canvas>
<footer>Meu Dividendo &copy; 2026</footer>

<script>
const API_KEY = "IV5PKYLN6WQK6FKW";
let chartInstance;

function formatBRL(n) { return parseFloat(n).toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); }
function formatNumber(n) { return parseFloat(n).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 }); }

async function buscarAtivo() {
  const query = document.getElementById('searchInput').value.trim().toUpperCase();
  if(!query) return alert("Digite um código de ativo!");
  
  const cardsDiv = document.getElementById('cards');
  cardsDiv.innerHTML = '';
  if(chartInstance) chartInstance.destroy();

  try {
    const res = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${query}&apikey=${API_KEY}&outputsize=compact`);
    const data = await res.json();
    if(!data["Time Series (Daily)"]) return alert("Ativo não encontrado ou dados indisponíveis!");

    const dias = Object.keys(data["Time Series (Daily)"]).sort().reverse();
    const hoje = dias[0];
    const todayData = data["Time Series (Daily)"][hoje];

    const preco = parseFloat(todayData["4. close"]);
    const abertura = parseFloat(todayData["1. open"]);
    const maxima = parseFloat(todayData["2. high"]);
    const minima = parseFloat(todayData["3. low"]);
    const volume = parseInt(todayData["6. volume"]);
    const variacao = ((preco - abertura)/abertura*100).toFixed(2) + "%";

    // Cards principais
    const mainCard = document.createElement('div');
    mainCard.className = 'card wide';
    mainCard.innerHTML = `<strong>${query}</strong><br>${formatBRL(preco)}<br><small>${hoje}</small>`;
    cardsDiv.appendChild(mainCard);

    // Cards secundários
    const cardData = [
      ["Abertura", formatBRL(abertura)],
      ["Máxima", formatBRL(maxima)],
      ["Mínima", formatBRL(minima)],
      ["Variação", variacao],
      ["Volume", volume.toLocaleString('pt-BR')]
    ];
    cardData.forEach(([k,v]) => {
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `<strong>${k}</strong><br>${v}`;
      cardsDiv.appendChild(c);
    });

    // Indicadores calculados
    // P/VP, ROE, DY usando histórico básico
    const prices = dias.map(d => parseFloat(data["Time Series (Daily)"][d]["4. close"]));
    const meanPrice = prices.reduce((a,b)=>a+b,0)/prices.length;

    const pvp = "N/D"; // Sem dados fundamentalistas reais
    const roe = "N/D";
    const dy = "N/D";

    const indCard = document.createElement('div');
    indCard.className='card wide';
    indCard.innerHTML = `<strong>Indicadores</strong><br>P/VP: ${pvp}<br>ROE: ${roe}<br>DY: ${dy}`;
    cardsDiv.appendChild(indCard);

    // Gráfico histórico
    const labels = dias.reverse();
    const closes = labels.map(d => parseFloat(data["Time Series (Daily)"][d]["4. close"]));

    const ctx = document.getElementById('historyChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:`${query} - Fechamento (R$)`,
          data: closes,
          borderColor:'blue',
          backgroundColor:'rgba(0,0,255,0.2)',
          fill:true
        }]
      },
      options:{
        responsive:true,
        scales:{
          x:{ display:true },
          y:{ display:true, ticks:{ callback: v => formatBRL(v) } }
        }
      }
    });

  } catch(err) {
    console.error(err);
    alert("Erro ao buscar o ativo.");
  }
}
</script>

</body>
</html>