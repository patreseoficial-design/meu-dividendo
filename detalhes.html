<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Dividendo - Pesquisa de Ativos e FIIs</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  header { background:#000; color:#fff; padding:16px; text-align:center; font-size:1.2em; position:relative; }
  #menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
  #searchContainer { text-align:center; margin:20px; }
  #searchInput { padding:8px; font-size:1em; width:200px; }
  #resultado { max-width:800px; margin:20px auto; background:#fff; padding:16px; border-radius:12px; }
  #resultado h2 { margin:0 0 12px 0; }
  #infoGrid { display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:12px; }
  #infoGrid div { background:#f0f0f0; padding:12px; border-radius:8px; text-align:center; }
  #volumeVar { background:#f0f0f0; padding:12px; border-radius:8px; margin-bottom:12px; }
  #historyChart { max-width:100%; height:300px; }
  .lista-fixa { max-width:800px; margin:20px auto; background:#fff; padding:16px; border-radius:12px; }
  .lista-fixa h3 { margin-top:0; }
  .linha { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #ddd; }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span>
  Meu Dividendo - Pesquisa de Ativos e FIIs
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o código do ativo ou FII">
  <button onclick="buscarAtivo()">Buscar</button>
</div>

<div id="resultado"></div>

<div class="lista-fixa" id="topAcoes">
  <h3>20 Ações Mais Negociadas</h3>
  <div id="acoesList">Carregando...</div>
</div>

<div class="lista-fixa" id="topFIIs">
  <h3>20 FIIs Mais Negociados</h3>
  <div id="fiisList">Carregando...</div>
</div>

<script>
const alphaKey = "IV5PKYLN6WQK6FKW";
const brapiKey = "iTFTqSn6W2cyuHNrhcM2rJ";
let chartInstance;

// Funções auxiliares
function formatBRL(n){ return parseFloat(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function formatNumber(n){ return parseFloat(n).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function buscarAtivo(){
  const query = document.getElementById('searchInput').value.trim().toUpperCase();
  if(!query) return alert("Digite um ativo ou FII!");

  const resultadoDiv = document.getElementById('resultado');
  resultadoDiv.innerHTML = 'Carregando...';

  // 1️⃣ Tentar Alpha Vantage (ações)
  let ativo = null;
  try {
    const resAlpha = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${query}&apikey=${alphaKey}`);
    const dataAlpha = await resAlpha.json();
    if(dataAlpha["Global Quote"] && Object.keys(dataAlpha["Global Quote"]).length>0) ativo = {tipo:'acao', dados:dataAlpha["Global Quote"]};
  } catch(e){ console.error(e); }

  // 2️⃣ Se não achou ou é FII -> Brapi com key
  if(!ativo){
    try{
      const resBrapi = await fetch(`https://brapi.dev/api/quote/${query}?apikey=${brapiKey}`);
      const dataBrapi = await resBrapi.json();
      if(dataBrapi.results && dataBrapi.results.length>0) ativo = {tipo:dataBrapi.results[0].type, dados:dataBrapi.results[0]};
    } catch(e){ console.error(e); }
  }

  if(!ativo) return resultadoDiv.innerHTML = "<p>Ativo não encontrado.</p>";

  // Monta layout
  const d = ativo.dados;
  const preco = ativo.tipo==='acao'? parseFloat(d["05. price"]||d.price):parseFloat(d.price);
  const abertura = ativo.tipo==='acao'? parseFloat(d["02. open"]||d.open):parseFloat(d.open);
  const maxima = ativo.tipo==='acao'? parseFloat(d["03. high"]||d.high):parseFloat(d.high);
  const minima = ativo.tipo==='acao'? parseFloat(d["04. low"]||d.low):parseFloat(d.low);
  const volume = ativo.tipo==='acao'? parseInt(d["06. volume"]||d.volume):parseInt(d.volume);
  const variacao = ativo.tipo==='acao'? d["10. change percent"]||((preco-abertura)/abertura*100).toFixed(2)+"%":d.changePercentage;

  resultadoDiv.innerHTML = `
    <h2>${query}</h2>
    <div id="infoGrid">
      <div>Preço<br><strong>${formatBRL(preco)}</strong></div>
      <div>Abertura<br><strong>${formatBRL(abertura)}</strong></div>
      <div>Máxima<br><strong>${formatBRL(maxima)}</strong></div>
      <div>Mínima<br><strong>${formatBRL(minima)}</strong></div>
    </div>
    <div id="volumeVar">
      Volume: ${volume.toLocaleString('pt-BR')} | Variação: ${variacao}
    </div>
    <canvas id="historyChart"></canvas>
  `;

  // Gráfico simplificado: linha azul com abertura, mínima, máxima e fechamento
  const ctx = document.getElementById('historyChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'line',
    data:{
      labels:['Abertura','Mínima','Máxima','Fechamento'],
      datasets:[{
        label: `${query} - Preço`,
        data:[abertura,minima,maxima,preco],
        borderColor:'blue',
        backgroundColor:'rgba(0,0,255,0.2)',
        fill:true
      }]
    },
    options:{responsive:true}
  });
}

// 20 mais ações (Brapi GitHub)
async function carregarTopAcoes(){
  const listDiv = document.getElementById('acoesList');
  try{
    const res = await fetch('https://brapi.dev/api/stock/list?mkt=stocks'); // Exemplo GitHub público
    const data = await res.json();
    const top = data.slice(0,20);
    listDiv.innerHTML = '';
    top.forEach(a=>{
      const linha = document.createElement('div');
      linha.className='linha';
      linha.innerHTML=`<span>${a.symbol}</span><span>${formatBRL(a.price)}</span>`;
      listDiv.appendChild(linha);
    });
  } catch(e){ console.error(e); listDiv.innerHTML="Erro ao carregar ações."; }
}

// 20 mais FIIs (Brapi GitHub)
async function carregarTopFIIs(){
  const listDiv = document.getElementById('fiisList');
  try{
    const res = await fetch('https://brapi.dev/api/stock/list?mkt=fii'); // Exemplo GitHub público
    const data = await res.json();
    const top = data.slice(0,20);
    listDiv.innerHTML = '';
    top.forEach(f=>{
      const linha = document.createElement('div');
      linha.className='linha';
      linha.innerHTML=`<span>${f.symbol}</span><span>${formatBRL(f.price)}</span>`;
      listDiv.appendChild(linha);
    });
  } catch(e){ console.error(e); listDiv.innerHTML="Erro ao carregar FIIs."; }
}

// Inicializa
carregarTopAcoes();
carregarTopFIIs();
</script>

</body>
</html>