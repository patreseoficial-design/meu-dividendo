<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detalhes do Ativo</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; color:#333; }
header { background:#000; color:#fff; padding:16px; text-align:center; position:relative; border-bottom:1px solid #222; }
#nomeAtivo { text-align:center; margin:24px 0; font-size:2em; font-weight:bold; }
#cards { display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:24px; }
.card { background:#000; color:#fff; padding:16px 24px; border-radius:12px; text-align:center; }
.section { margin:20px; background:#fff; padding:16px; border-radius:12px; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { padding:8px; border:1px solid #ccc; text-align:center; }
th { background:#eee; }
canvas { max-width:100%; }
.menu { font-size:1.5em; cursor:pointer; position:absolute; left:16px; top:16px; }
.menu-links { position:fixed; top:0; left:0; width:250px; height:100%; background:#fff; color:#000; padding-top:60px; display:none; flex-direction:column; z-index:1000; border-right:1px solid #ccc; }
.menu-links ul { list-style:none; padding:0; margin:0; }
.menu-links li { margin:16px 0; }
.menu-links a { color:#000; text-decoration:none; font-size:1.1em; padding:8px 16px; display:block; }
#indicadores { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
#errorMsg { color:red; font-weight:bold; margin:16px; }
</style>
</head>
<body>

<header>
  <div class="menu" onclick="toggleMenu()">‚ò∞</div>
  <h1>Meu Dividendo</h1>
  <nav id="menuLinks" class="menu-links">
    <ul>
      <li><a href="index.html">üè† In√≠cio</a></li>
      <li><a href="calculadora.html">Calculadora de juros compostos</a></li>
      <li><a href="calculadora-rescisao.html">Calculadora de rescis√£o</a></li>
      <li><a href="calculadora-13salario.html">Calculadora de 13¬∫ Sal√°rio</a></li>
      <li><a href="calculadora-ir.html">Calculadora imposto de renda sobre Investimentos</a></li>
      <li><a href="quanto-investir-por-mes.html">Quanto investir por m√™s</a></li>
      <li><a href="calculadora-pis.html">Calculadora do PIS</a></li>
      <li><a href="calculadora-quitacao.html">Calculadora de quita√ß√£o patrimonial</a></li>
    </ul>
  </nav>
</header>

<script>
function toggleMenu() {
  const menu = document.getElementById('menuLinks');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// ====================== CONFIGURA√á√ÉO DAS CHAVES ======================
const BRAPI_KEY = "COLOQUE_SUA_KEY_BRAAPI_AQUI";
const ALPHA_KEY = "3D5Q8G9JDMWBXMJ0";

// ====================== FUN√á√ÉO PARA BUSCAR DADOS ======================
async function buscarAtivo(ticker) {
  const errorDiv = document.getElementById("errorMsg");
  let ativo = null;

  // --- Tenta Brapi primeiro ---
  try {
    const brapiUrl = `https://brapi.dev/api/quote/${ticker}?apikey=${BRAPI_KEY}`;
    const res = await fetch(brapiUrl);
    const data = await res.json();

    if (data?.results && data.results.length > 0) {
      const r = data.results[0];
      ativo = {
        ticker: r.symbol,
        preco_atual: { valor: r.regularMarketPrice, variacao_dia: r.regularMarketChangePercent },
        historico_precos: { dados: (r.historicalData || []).map(h=>({data:h.date, close:h.close})) },
        dividendos: { dados: (r.dividends || []).map(d=>({data_ex:d.exDate, payDate:d.payDate, valor:d.amount})) },
        indicadores: {
          pvp: r.pvToPrice,
          dy_12m: r.dividendYield,
          patrimonio_liquido: r.bookValue,
          valor_mercado: r.marketCap
        },
        patrimonio_carteira: null
      };
    } else {
      errorDiv.textContent = `Ativo "${ticker}" n√£o encontrado na Brapi.`;
    }
  } catch(e){
    console.error("Erro Brapi:", e);
    errorDiv.textContent = "Erro ao buscar na Brapi. Tentando Alpha Vantage...";
  }

  // --- Se faltar dados, tenta Alpha Vantage ---
  if(!ativo || !ativo.preco_atual) {
    try {
      const alphaUrl = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${ticker}.SA&apikey=${ALPHA_KEY}`;
      const res = await fetch(alphaUrl);
      const data = await res.json();
      const dates = Object.keys(data["Time Series (Daily)"] || {});
      if (dates.length > 0) {
        const last = dates[0];
        ativo = ativo || {};
        ativo.ticker = ticker;
        ativo.preco_atual = { valor: parseFloat(data["Time Series (Daily)"][last]["4. close"]), variacao_dia: null };
        ativo.historico_precos = { dados: dates.slice(0,90).map(d=>({data:d, close:parseFloat(data["Time Series (Daily)"][d]["4. close"])})) };
      }
    } catch(e){
      console.error("Erro Alpha Vantage:", e);
      errorDiv.textContent += " Erro Alpha Vantage tamb√©m.";
    }
  }

  return ativo;
}

// ====================== RENDERIZA√á√ÉO ======================
async function renderizarAtivo() {
  const params = new URLSearchParams(window.location.search);
  const ticker = params.get("ativo");
  if(!ticker){ alert("Nenhum ativo informado!"); return; }

  const ativo = await buscarAtivo(ticker);
  if(!ativo){ return; }

  document.getElementById("nomeAtivo").textContent = ativo.ticker;
  const errorDiv = document.getElementById("errorMsg");
  errorDiv.textContent = `JSON carregado com sucesso: ${ticker}`;

  // Cards de pre√ßo e varia√ß√£o
  const cardsDiv = document.getElementById("cards");
  cardsDiv.innerHTML = "";
  const cardsInfo = [
    {label:"Pre√ßo", value:`R$ ${ativo.preco_atual?.valor ?? "--"}`},
    {label:"Varia√ß√£o", value:`${ativo.preco_atual?.variacao_dia ?? "--"}%`}
  ];
  cardsInfo.forEach(i=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `<strong>${i.label}</strong><br>${i.value}`;
    cardsDiv.appendChild(card);
  });

  // Gr√°fico hist√≥rico
  const ctx = document.getElementById('precoChart').getContext('2d');
  const datas = (ativo.historico_precos?.dados || []).map(d=>d.data);
  const precos = (ativo.historico_precos?.dados || []).map(d=>d.close);
  new Chart(ctx,{
    type:'line',
    data:{ labels:datas, datasets:[{label:'Pre√ßo', data:precos, borderColor:'#007bff', backgroundColor:'rgba(0,123,255,0.1)'}] },
    options:{ responsive:true, plugins:{ legend:{display:true}, tooltip:{mode:'index'} } }
  });

  // Dividendos
  const tbody = document.querySelector("#dividendosTable tbody");
  tbody.innerHTML="";
  (ativo.dividendos?.dados||[]).forEach(div=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${div.data_ex}</td><td>${div.payDate??"--"}</td><td>R$ ${div.valor}</td>`;
    tbody.appendChild(tr);
  });

  // Indicadores
  const indicadoresDiv = document.getElementById("indicadores");
  indicadoresDiv.innerHTML="";
  const ind = ativo.indicadores || {};
  const indicadores = [
    {label:"P/VP", value:ind.pvp ?? "--"},
    {label:"Dividend Yield", value:ind.dy_12m ?? "--"},
    {label:"Patrim√¥nio L√≠quido", value:ind.patrimonio_liquido ?? "--"},
    {label:"Valor de Mercado", value:ind.valor_mercado ?? "--"},
    {label:"Patrim√¥nio na Carteira", value:ativo.patrimonio_carteira ?? "--"}
  ];
  indicadores.forEach(i=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `<strong>${i.label}</strong><br>${i.value}`;
    indicadoresDiv.appendChild(card);
  });
}

// ====================== EXECUTA ======================
renderizarAtivo();
</script>

<div id="cards"></div>
<div class="section">
  <h3>Hist√≥rico de Pre√ßos</h3>
  <canvas id="precoChart"></canvas>
</div>
<div class="section">
  <h3>Dividendos / Rendimentos</h3>
  <table id="dividendosTable">
    <thead><tr><th>Data Ex</th><th>Data Pagamento</th><th>Valor</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<div class="section">
  <h3>Indicadores Financeiros</h3>
  <div id="indicadores"></div>
</div>

</body>
</html>