<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Dividendo - A√ß√µes & FIIs</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  header { background:#000; color:#fff; padding:16px; text-align:center; font-size:1.2em; position: relative; }
  #menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
  #searchContainer { text-align:center; margin:20px; }
  #searchInput { padding:8px; font-size:1em; width:200px; }
  #resultado { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:20px; }
  .card { background:#000; color:#fff; padding:16px 24px; border-radius:12px; min-width:140px; text-align:center; }
  .card.wide { min-width:300px; font-size:1.1em; }
  #boxVolumeGrafico { background:#fff; padding:16px; border-radius:12px; margin:20px auto; max-width:800px; }
  #volumeVar { display:flex; justify-content:space-between; margin-bottom:12px; font-weight:bold; }
  #historyChart { width:100%; height:300px; }
  .top20Container { display:flex; justify-content:space-around; margin:20px auto; max-width:900px; gap:12px; }
  .top20Box { background:#eee; border-radius:12px; padding:12px; flex:1; min-width:200px; max-height:220px; overflow:hidden; }
  .top20Box h3 { text-align:center; margin:8px 0; }
  .ticker { white-space:nowrap; overflow:hidden; position:relative; border-top:1px solid #ccc; border-bottom:1px solid #ccc; background:#ddd; padding:8px 0; margin:12px auto; max-width:800px; }
  .ticker div { display:inline-block; padding:0 24px; animation: tickerMove 40s linear infinite; font-weight:bold; }
  @keyframes tickerMove { 0% { transform:translateX(100%); } 100% { transform:translateX(-100%); } }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span>
  Meu Dividendo - A√ß√µes & FIIs
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o c√≥digo do ativo (ex: PETR4.SA ou MXRF11)">
  <button onclick="buscarAtivo()">Buscar</button>
</div>

<div id="resultado"></div>

<div id="boxVolumeGrafico">
  <div id="volumeVar">
    <span id="volumeText">Volume: -</span>
    <span id="variacaoText">Varia√ß√£o: -</span>
  </div>
  <canvas id="historyChart"></canvas>
</div>

<div class="top20Container">
  <div class="top20Box" id="topAcoes"><h3>Top 10 A√ß√µes</h3><div id="acoesList"></div></div>
  <div class="top20Box" id="topFiis"><h3>Top 10 FIIs</h3><div id="fiisList"></div></div>
</div>

<div class="ticker" id="ticker20"></div>

<script>
const API_ALPHA = "IV5PKYLN6WQK6FKW";
const API_BRAPI_KEY = "iTFTqSn6W2cyuHNrhcM2rJ";
let chartInstance;

async function buscarAtivo() {
  const query = document.getElementById('searchInput').value.trim().toUpperCase();
  if(!query) return alert("Digite um ativo!");

  const resultadoDiv = document.getElementById('resultado');
  resultadoDiv.innerHTML = '';
  document.getElementById('volumeText').textContent = "Volume: -";
  document.getElementById('variacaoText').textContent = "Varia√ß√£o: -";
  if(chartInstance) chartInstance.destroy();

  let data = null;

  // 1Ô∏è‚É£ Tenta Alpha
  try {
    const resAlpha = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${query}&apikey=${API_ALPHA}`);
    const alphaJson = await resAlpha.json();
    if(alphaJson["Global Quote"] && Object.keys(alphaJson["Global Quote"]).length) data = alphaJson["Global Quote"];
  } catch(e){}

  // 2Ô∏è‚É£ Se n√£o veio nada tenta Brapi com key
  if(!data) {
    try {
      const resBrapi = await fetch(`https://brapi.dev/api/quote/${query}?apikey=${API_BRAPI_KEY}`);
      const brapiJson = await resBrapi.json();
      if(brapiJson.results && brapiJson.results.length) data = brapiJson.results[0];
    } catch(e){}
  }

  if(!data) return alert("Ativo n√£o encontrado ou indispon√≠vel!");

  const formatBRL = v => parseFloat(v).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  const formatNum = v => parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });

  // Cria cards
  const isFII = query.endsWith("11");
  const papel = data["01. symbol"] || data["stock"] || data["symbol"];
  const preco = parseFloat(data["05. price"] || data["regularMarketPrice"] || 0);
  const abertura = parseFloat(data["02. open"] || data["regularMarketOpen"] || 0);
  const maxima = parseFloat(data["03. high"] || data["regularMarketDayHigh"] || 0);
  const minima = parseFloat(data["04. low"] || data["regularMarketDayLow"] || 0);
  const volume = parseInt(data["06. volume"] || data["regularMarketVolume"] || 0);
  const variacao = data["10. change percent"] || data["regularMarketChangePercent"] || 0;

  const mainCard = document.createElement('div');
  mainCard.className='card wide';
  mainCard.innerHTML = `<strong>${papel}</strong><br>${formatBRL(preco)}<br><small>${data["07. latest trading day"] || data["regularMarketTime"] || "-"}</small>`;
  resultadoDiv.appendChild(mainCard);

  const cardData = [
    ["Abertura", formatBRL(abertura)],
    ["M√°xima", formatBRL(maxima)],
    ["M√≠nima", formatBRL(minima)],
    ["Pre√ßo atual", formatBRL(preco)]
  ];
  cardData.forEach(([k,v])=>{
    const c = document.createElement('div');
    c.className='card';
    c.innerHTML=`<strong>${k}</strong><br>${v}`;
    resultadoDiv.appendChild(c);
  });

  document.getElementById('volumeText').textContent = `Volume: ${volume.toLocaleString('pt-BR')}`;
  document.getElementById('variacaoText').textContent = `Varia√ß√£o: ${formatNum(variacao)}%`;

  // Gr√°fico üìà s√≥ com abertura, m√°xima, m√≠nima, fechamento
  const ctx = document.getElementById('historyChart').getContext('2d');
  const labels = ["Abertura","M√°xima","M√≠nima","Fechamento"];
  const dataGraf = [abertura,maxima,minima,preco];
  chartInstance = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{label:papel, data:dataGraf, borderColor:'blue', backgroundColor:'rgba(0,0,255,0.2)', fill:true}] },
    options:{ responsive:true, scales:{ y:{ ticks:{ callback: v => formatBRL(v) } } } }
  });
}

// Fun√ß√£o top 20 fixos
async function carregarTop20() {
  const acoesList = document.getElementById('acoesList');
  const fiisList = document.getElementById('fiisList');
  const tickerDiv = document.getElementById('ticker20');

  // 10 A√ß√µes fixas (exemplo)
  const topAcoes = ["VALE3","PETR4","ITUB4","BBDC4","ABEV3","MGLU3","WEGE3","BBAS3","SUZB3","LREN3"];
  // 10 FIIs fixos (exemplo)
  const topFiis = ["MXRF11","KNRI11","HGLG11","VISC11","BCFF11","XPML11","FIIB11","HGBS11","RBRP11","RECT11"];

  const promisesAcoes = topAcoes.map(async s=>{
    try {
      const res = await fetch(`https://brapi.dev/api/quote/${s}?apikey=${API_BRAPI_KEY}`);
      const r = await res.json();
      const stock = r.results[0];
      return `${stock.symbol}: ${parseFloat(stock.regularMarketPrice).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}`;
    } catch{return `${s}: -`;}
  });
  const promisesFiis = topFiis.map(async s=>{
    try {
      const res = await fetch(`https://brapi.dev/api/quote/${s}?apikey=${API_BRAPI_KEY}`);
      const r = await res.json();
      const fii = r.results[0];
      return `${fii.symbol}: ${parseFloat(fii.regularMarketPrice).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}`;
    } catch{return `${s}: -`;}
  });

  const resAcoes = await Promise.all(promisesAcoes);
  const resFiis = await Promise.all(promisesFiis);

  acoesList.innerHTML = resAcoes.map(v=>`<div>${v}</div>`).join('');
  fiisList.innerHTML = resFiis.map(v=>`<div>${v}</div>`).join('');
  tickerDiv.innerHTML = resAcoes.concat(resFiis).map(v=>`<div>${v}</div>`).join('');
}

// Inicializa top20
carregarTop20();
</script>

</body>
</html>