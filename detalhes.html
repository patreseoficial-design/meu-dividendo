<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Dividendo - Alpha Vantage</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  header { background:#000; color:#fff; padding:16px; text-align:center; font-size:1.2em; position: relative; }
  #menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
  #searchContainer { text-align:center; margin:20px; }
  #searchInput { padding:8px; font-size:1em; width:200px; }
  #cards { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:20px; }
  .card { background:#000; color:#fff; padding:16px 24px; border-radius:12px; min-width:140px; text-align:center; }
  .card.wide { min-width:300px; font-size:1.1em; }
  #historyChart { max-width:800px; margin:20px auto; background:#fff; border-radius:12px; padding:16px; }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span>
  Meu Dividendo - Alpha Vantage
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o código do ativo (ex: PETR4.SA)">
  <button onclick="buscarAtivo()">Buscar</button>
</div>

<div id="cards"></div>
<canvas id="historyChart"></canvas>

<script>
const API_KEY = "IV5PKYLN6WQK6FKW"; // sua chave Alpha Vantage
let chartInstance;

async function buscarAtivo() {
  const queryInput = document.getElementById('searchInput').value.trim().toUpperCase();
  if(!queryInput) return alert("Digite um ativo!");

  const symbol = queryInput; // Aqui a pessoa já deve colocar .SA se brasileiro
  const cardsDiv = document.getElementById('cards');
  cardsDiv.innerHTML = '';

  // Busca dados intraday/dia atual
  const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&apikey=${API_KEY}&outputsize=compact`;
  const res = await fetch(url);
  const data = await res.json();

  if(data["Error Message"] || !data["Time Series (Daily)"]) {
    return alert("Ativo não encontrado ou dados indisponíveis!");
  }

  // Pega a data mais recente
  const dias = Object.keys(data["Time Series (Daily)"]).sort().reverse();
  const hoje = dias[0];
  const todayData = data["Time Series (Daily)"][hoje];

  // Formatação números em R$
  const formatReal = n => parseFloat(n).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  const formatNumber = n => parseFloat(n).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });

  // Calcula indicadores básicos
  const preco = parseFloat(todayData["4. close"]);
  const abertura = parseFloat(todayData["1. open"]);
  const maxima = parseFloat(todayData["2. high"]);
  const minima = parseFloat(todayData["3. low"]);
  const volume = parseInt(todayData["6. volume"]);

  const variacao = ((preco - abertura)/abertura*100).toFixed(2) + "%";

  // Cards principais
  const mainCard = document.createElement('div');
  mainCard.className = 'card wide';
  mainCard.innerHTML = `<strong>${symbol}</strong><br>${formatReal(preco)}<br><small>${hoje}</small>`;
  cardsDiv.appendChild(mainCard);

  // 4 cards secundários
  const cardData = [
    ["Abertura", formatReal(abertura)],
    ["Máxima", formatReal(maxima)],
    ["Mínima", formatReal(minima)],
    ["Variação", variacao]
  ];

  cardData.forEach(([k,v])=>{
    const c = document.createElement('div');
    c.className='card';
    c.innerHTML=`<strong>${k}</strong><br>${v}`;
    cardsDiv.appendChild(c);
  });

  // Volume
  const volCard = document.createElement('div');
  volCard.className='card';
  volCard.innerHTML=`<strong>Volume</strong><br>${volume.toLocaleString('pt-BR')}`;
  cardsDiv.appendChild(volCard);

  // Calcula P/VP e ROE básico a partir do histórico se não houver
  // Placeholder: não disponível sem dados fundamentalistas
  const pvp = "N/D"; 
  const roe = "N/D";
  const roic = "N/D";
  const dy = "N/D";

  const indCard = document.createElement('div');
  indCard.className='card wide';
  indCard.innerHTML=`<strong>Indicadores</strong><br>P/VP: ${pvp}<br>ROE: ${roe}<br>ROIC: ${roic}<br>DY: ${dy}`;
  cardsDiv.appendChild(indCard);

  // Histórico: gráfico de preços
  const labels = dias.reverse();
  const closes = labels.map(d=>parseFloat(data["Time Series (Daily)"][d]["4. close"]));

  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('historyChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[{
        label:`${symbol} - Preço de Fechamento`,
        data: closes,
        borderColor:'blue',
        backgroundColor:'rgba(0,0,255,0.2)',
        fill:true
      }]
    },
    options:{
      responsive:true,
      scales:{
        x:{ display:true },
        y:{ display:true, ticks:{ callback: v => formatReal(v) } }
      }
    }
  });
}
</script>

</body>
</html>