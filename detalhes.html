<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detalhes do Ativo - Meu Dividendo</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
header { background:#000; color:#fff; padding:16px; position:relative; font-size:1.2em; }
#menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
#searchContainer { text-align:center; margin:20px; }
#searchInput { padding:8px; font-size:1em; width:200px; }
#cards { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:20px; }
.card { background:#000; color:#fff; padding:16px 24px; border-radius:12px; min-width:140px; text-align:center; }
.card.wide { min-width:300px; font-size:1.1em; }
#chartContainer { background:#fff; border-radius:12px; padding:16px; margin:20px; }
#top20Container { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:20px; }
.top20Card { background:#ddd; color:#000; padding:8px 12px; border-radius:8px; min-width:100px; text-align:center; }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span>
  Detalhes do Ativo
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o código do ativo (ex: PETR4.SA ou MXRF11)">
  <button onclick="buscarAtivo()">Buscar</button>
</div>

<div id="cards"></div>

<div id="chartContainer">
  <canvas id="historyChart"></canvas>
</div>

<h3 style="text-align:center">20 Mais Negociadas - Ações</h3>
<div id="top20Actions" class="top20Container"></div>

<h3 style="text-align:center">20 Mais Negociadas - FIIs</h3>
<div id="top20FIIs" class="top20Container"></div>

<script>
const ALPHA_KEY = "IV5PKYLN6WQK6FKW";
const BRAPI_KEY = "iTFTqSn6W2cyuHNrhcM2rJ";
let chartInstance;

// Função para pegar query string
function getQueryParam(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// Formatação
const formatBRL = n => parseFloat(n).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
const formatPercent = n => parseFloat(n).toFixed(2) + "%";

// Busca do ativo
async function buscarAtivo() {
  const input = document.getElementById('searchInput');
  let symbol = input.value.trim().toUpperCase();
  if(!symbol) return alert("Digite um ativo!");
  
  document.getElementById('cards').innerHTML = '';
  if(chartInstance) chartInstance.destroy();

  // Primeiro tenta Alpha
  let ativoData = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_KEY}`)
    .then(r => r.json())
    .then(d => d["Global Quote"] ? d["Global Quote"] : null)
    .catch(()=>null);

  // Se não achou Alpha, tenta Brapi com Key
  if(!ativoData) {
    ativoData = await fetch(`https://brapi.dev/api/quote/${symbol}?apikey=${BRAPI_KEY}`)
      .then(r => r.json())
      .then(d => d.results ? d.results[0] : null)
      .catch(()=>null);
  }

  if(!ativoData) return alert("Ativo não encontrado!");

  // Identifica se é FII
  const isFII = symbol.includes("FII") || symbol.includes("11");

  // Extrai dados
  let preco, abertura, maxima, minima, variacao, volume, data;
  if(ativoData["01. symbol"]) { // Alpha
    preco = parseFloat(ativoData["05. price"]);
    abertura = parseFloat(ativoData["02. open"]);
    maxima = parseFloat(ativoData["03. high"]);
    minima = parseFloat(ativoData["04. low"]);
    variacao = ativoData["10. change percent"];
    volume = parseInt(ativoData["06. volume"]);
    data = ativoData["07. latest trading day"];
  } else { // Brapi
    preco = ativoData.regularMarketPrice;
    abertura = ativoData.regularMarketOpen;
    maxima = ativoData.regularMarketDayHigh;
    minima = ativoData.regularMarketDayLow;
    variacao = ativoData.regularMarketChangePercent;
    volume = ativoData.regularMarketVolume;
    data = ativoData.regularMarketTime ? new Date(ativoData.regularMarketTime*1000).toLocaleDateString('pt-BR') : "";
  }

  // Cards principais
  const cardsDiv = document.getElementById('cards');
  const mainCard = document.createElement('div');
  mainCard.className = 'card wide';
  mainCard.innerHTML = `<strong>${symbol}</strong><br>${formatBRL(preco)}<br><small>${data}</small>`;
  cardsDiv.appendChild(mainCard);

  const cardData = [
    ["Abertura", formatBRL(abertura)],
    ["Máxima", formatBRL(maxima)],
    ["Mínima", formatBRL(minima)],
    ["Variação", formatPercent(variacao)]
  ];

  cardData.forEach(([k,v])=>{
    const c = document.createElement('div');
    c.className='card';
    c.innerHTML=`<strong>${k}</strong><br>${v}`;
    cardsDiv.appendChild(c);
  });

  const volCard = document.createElement('div');
  volCard.className='card';
  volCard.innerHTML=`<strong>Volume</strong><br>${volume ? volume.toLocaleString('pt-BR') : "-"}`;
  cardsDiv.appendChild(volCard);

  // Gráfico simples: usa abertura, máxima, mínima e fechamento
  const ctx = document.getElementById('historyChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type:'line',
    data:{
      labels:["Abertura","Máxima","Mínima","Fechamento"],
      datasets:[{
        label:`${symbol} - Valores do dia`,
        data:[abertura,maxima,minima,preco],
        borderColor:'blue',
        backgroundColor:'rgba(0,0,255,0.2)',
        fill:true
      }]
    },
    options:{ responsive:true }
  });
}

// Carrega top20 ações e FIIs do Brapi Github
async function carregarTop20() {
  // Ações
  let actions = await fetch(`https://brapi.dev/api/stock/list`)
    .then(r=>r.json())
    .then(d=>d.stocks.slice(0,20))
    .catch(()=>[]);
  const top20Actions = document.getElementById('top20Actions');
  actions.forEach(a=>{
    const c = document.createElement('div');
    c.className='top20Card';
    c.innerHTML=`${a.stock} <br> ${formatBRL(a.price)}`;
    top20Actions.appendChild(c);
  });

  // FIIs
  let fiis = await fetch(`https://brapi.dev/api/fii/list`)
    .then(r=>r.json())
    .then(d=>d.results.slice(0,20))
    .catch(()=>[]);
  const top20FIIs = document.getElementById('top20FIIs');
  fiis.forEach(f=>{
    const c = document.createElement('div');
    c.className='top20Card';
    c.innerHTML=`${f.symbol} <br> ${formatBRL(f.price)}`;
    top20FIIs.appendChild(c);
  });
}

// Inicializa
window.onload = ()=>{
  const ativoQuery = getQueryParam("ativo");
  if(ativoQuery) {
    document.getElementById('searchInput').value = ativoQuery;
    buscarAtivo();
  }
  carregarTop20();
}
</script>

</body>
</html>