<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Dividendo - Pesquisa de Ativos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
header { background:#000; color:#fff; padding:16px; text-align:center; position:relative; }
#menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
#searchContainer { text-align:center; margin:20px; }
#searchInput { padding:8px; font-size:1em; width:200px; }
#resultado { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:20px; }
.result-card { background:#000; color:#fff; padding:16px; border-radius:12px; text-align:center; min-width:140px; }
.result-card.wide { min-width:300px; font-size:1.1em; }
.info-box { background:#fff; padding:12px; border-radius:12px; margin:12px auto; max-width:700px; }
#historyChart { max-width:700px; margin:20px auto; }
#maisContainer { display:flex; flex-direction:column; gap:20px; margin:20px; }
.mais-box { background:#ddd; padding:12px; border-radius:12px; display:flex; flex-wrap:wrap; gap:12px; overflow:hidden; }
.ativo-box { background:#fff; padding:8px 12px; border-radius:8px; text-align:center; min-width:90px; }
.ticker { white-space:nowrap; display:inline-block; padding-left:100%; animation: ticker 30s linear infinite; }
@keyframes ticker { 0% { transform:translateX(0%); } 100% { transform:translateX(-100%); } }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span> Meu Dividendo - Pesquisa de Ativos
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o código do ativo (ex: PETR4.SA ou MXRF11)">
  <button onclick="buscarAtivo()">Buscar</button>
</div>

<div id="resultado"></div>

<div class="info-box" id="boxInfo"></div>
<canvas id="historyChart"></canvas>

<div id="maisContainer">
  <div class="mais-box" id="maisAcoes">
    <div class="ticker" id="tickerAcoes"></div>
  </div>
  <div class="mais-box" id="maisFiis">
    <div class="ticker" id="tickerFiis"></div>
  </div>
</div>

<script>
const API_KEY_ALPHA = "IV5PKYLN6WQK6FKW";
const API_KEY_BRAPI = "iTFTqSn6W2cyuHNrhcM2rJ";
let chartInstance;

const acoes20 = ["PETR4.SA","VALE3.SA","ITUB4.SA","BBDC4.SA","ABEV3.SA","BBAS3.SA","MGLU3.SA","WEGE3.SA","RENT3.SA","LREN3.SA"];
const fiis20 = ["MXRF11","HGLG11","KNRI11","VISC11","BCFF11","HGRE11","XPML11","RBRF11","HSML11","BRCR11"];

function formatBRL(valor){ return parseFloat(valor).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function formatNumber(valor){ return parseFloat(valor).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function buscarAtivo(){
  const query = document.getElementById('searchInput').value.trim().toUpperCase();
  if(!query) return alert("Digite um ativo!");
  const resultadoDiv = document.getElementById('resultado');
  resultadoDiv.innerHTML="";
  document.getElementById("boxInfo").innerHTML="";
  if(chartInstance) chartInstance.destroy();

  // Função para tentar múltiplas APIs
  async function fetchDados(symbol){
    // 1 - Alpha
    let res = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&apikey=${API_KEY_ALPHA}&outputsize=compact`);
    let data = await res.json();
    if(data["Time Series (Daily)"]) return data;
    // 2 - Brapi GitHub (somente ações)
    if(!symbol.includes("11")){
      res = await fetch(`https://brapi.dev/api/quote/${symbol}`);
      data = await res.json();
      if(data.results && data.results.length>0) return data.results[0];
    }
    // 3 - Brapi com Key
    res = await fetch(`https://brapi.dev/api/quote/${symbol}?apikey=${API_KEY_BRAPI}`);
    data = await res.json();
    return data;
  }

  const data = await fetchDados(query);

  // Extrair informações
  let preco, abertura, maxima, minima, volume, variacao, dataStr;
  if(data["Time Series (Daily)"]){
    const dias = Object.keys(data["Time Series (Daily)"]).sort().reverse();
    dataStr = dias[0];
    const today = data["Time Series (Daily)"][dataStr];
    preco = parseFloat(today["4. close"]);
    abertura = parseFloat(today["1. open"]);
    maxima = parseFloat(today["2. high"]);
    minima = parseFloat(today["3. low"]);
    volume = parseInt(today["6. volume"]);
    variacao = ((preco - abertura)/abertura*100).toFixed(2)+"%";
  } else if(data.close){
    preco = parseFloat(data.close);
    abertura = parseFloat(data.open);
    maxima = parseFloat(data.high);
    minima = parseFloat(data.low);
    volume = parseInt(data.volume);
    variacao = parseFloat(data.regularMarketChangePercent).toFixed(2)+"%";
    dataStr = data.regularMarketTime ? new Date(data.regularMarketTime*1000).toLocaleDateString() : "-";
  } else {
    return alert("Ativo não encontrado ou dados indisponíveis!");
  }

  // Cards 2x2
  const cardMain = document.createElement("div");
  cardMain.className="result-card wide";
  cardMain.innerHTML=`<strong>${query}</strong><br>${formatBRL(preco)}<br><small>${dataStr}</small>`;
  resultadoDiv.appendChild(cardMain);

  const cardGrid = document.createElement("div");
  cardGrid.style.display="grid";
  cardGrid.style.gridTemplateColumns="repeat(2,1fr)";
  cardGrid.style.gap="12px";
  ["Abertura","Máxima","Mínima","Variação"].forEach((titulo,i)=>{
    const val = [abertura,maxima,minima,variacao][i];
    const c = document.createElement("div");
    c.className="result-card";
    c.innerHTML=`<strong>${titulo}</strong><br>${val}`;
    cardGrid.appendChild(c);
  });
  resultadoDiv.appendChild(cardGrid);

  // Caixa Volume + Variação
  const infoBox = document.getElementById("boxInfo");
  infoBox.innerHTML=`<strong>Volume:</strong> ${volume.toLocaleString('pt-BR')}<br><strong>Variação:</strong> ${variacao}`;

  // Gráfico OHLC azul
  const ctx = document.getElementById("historyChart").getContext("2d");
  chartInstance = new Chart(ctx,{
    type:'line',
    data:{ labels:["Abertura","Máxima","Mínima","Fechamento"], datasets:[{ label: query, data:[abertura,maxima,minima,preco], borderColor:'blue', backgroundColor:'rgba(0,0,255,0.2)', fill:true }] },
    options:{ responsive:true, plugins:{ legend:{ display:true } } }
  });
}

// Renderizar 20 mais ativos
function renderMais(){
  const tickerAcoes = document.getElementById("tickerAcoes");
  tickerAcoes.innerHTML = acoes20.map(a=>`<div class="ativo-box">${a}</div>`).join("");
  const tickerFiis = document.getElementById("tickerFiis");
  tickerFiis.innerHTML = fiis20.map(f=>`<div class="ativo-box">${f}</div>`).join("");
}
renderMais();
</script>

</body>
</html>