<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Dividendo - Painel 20 Mais</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  header { background:#000; color:#fff; padding:16px; text-align:center; font-size:1.2em; position: relative; }
  #menu { position:absolute; left:16px; top:16px; cursor:pointer; font-size:1.5em; }
  #searchContainer { text-align:center; margin:20px; }
  #searchInput { padding:8px; font-size:1em; width:200px; }
  .section-title { text-align:center; margin:16px 0; font-weight:bold; font-size:1.1em; }
  .cards-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:0 8px 16px 8px; }
  .card { background:#000; color:#fff; padding:12px 16px; border-radius:8px; min-width:120px; text-align:center; font-size:0.9em; }
  .card-wide { min-width:240px; font-size:1em; }
  #userCards { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:20px; }
  #chartContainer { max-width:800px; margin:20px auto; background:#fff; border-radius:12px; padding:16px; }
</style>
</head>
<body>

<header>
  <span id="menu">&#9776;</span>
  Meu Dividendo - Painel 20 Mais
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Digite o c√≥digo do ativo (ex: PETR4.SA ou MXRF11)">
  <button onclick="buscarAtivo()">Buscar</button>
</div>

<!-- Top 20 A√ß√µes -->
<div class="section-title">20 A√ß√µes Mais Negociadas</div>
<div id="topAcoes" class="cards-row"></div>

<!-- Top 20 FIIs -->
<div class="section-title">20 FIIs Mais Negociados</div>
<div id="topFiis" class="cards-row"></div>

<!-- Busca do usu√°rio -->
<div id="userCards"></div>

<div id="chartContainer">
  <canvas id="userChart"></canvas>
</div>

<script>
const ALPHA_KEY = "IV5PKYLN6WQK6FKW";
const BRAPI_KEY = "iTFTqSn6W2cyuHNrhcM2rJ";

// Listas fixas das 20 mais (apenas c√≥digo do papel)
const topAcoesList = ["PETR4.SA","VALE3.SA","ITUB4.SA","BBDC4.SA","ABEV3.SA","BBAS3.SA","WEGE3.SA","LREN3.SA","MGLU3.SA","GGBR4.SA","SUZB3.SA","JBSS3.SA","RENT3.SA","RAIL3.SA","HYPE3.SA","VVAR3.SA","BPAC11.SA","SANB11.SA","EGIE3.SA","COGN3.SA"];
const topFiisList = ["MXRF11","HGLG11","KNRI11","VISC11","BCFF11","XPLG11","HGRE11","HGBS11","RBRF11","XPML11","FIGS11","TORD11","LVBI11","VRTA11","KNCR11","MFII11","HFOF11","JSRE11","HCTR11","RBRP11"];

// Fun√ß√£o para formatar em R$
function formatBRL(v){return parseFloat(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function formatPerc(v){return parseFloat(v).toFixed(2)+"%";}

// Fun√ß√£o para popular uma lista fixa usando Brapi GitHub gratuita
async function popularLista(codigos, containerId, tipo){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  for(const c of codigos){
    try{
      const res = await fetch(`https://brapi.dev/api/quote/${c}`);
      const data = await res.json();
      const quote = data.results[0];
      if(!quote) continue;
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<strong>${quote.symbol}</strong><br>
                        ${formatBRL(quote.regularMarketPrice)}<br>
                        Abertura: ${formatBRL(quote.regularMarketOpen)}<br>
                        M√°x: ${formatBRL(quote.regularMarketDayHigh)}<br>
                        M√≠n: ${formatBRL(quote.regularMarketDayLow)}<br>
                        Varia√ß√£o: ${formatPerc(quote.regularMarketChangePercent)}`;
      container.appendChild(card);
    }catch(e){console.log("Erro:",c,e);}
  }
}

// Inicializa as 20 mais
popularLista(topAcoesList,'topAcoes','acoes');
popularLista(topFiisList,'topFiis','fiis');

// Busca do usu√°rio
let chartInstance;
async function buscarAtivo(){
  const query = document.getElementById('searchInput').value.trim().toUpperCase();
  if(!query) return alert("Digite um ativo!");
  const userCards = document.getElementById('userCards');
  userCards.innerHTML = '';

  // Fun√ß√£o de fallback: Alpha ‚Üí Brapi GitHub gr√°tis ‚Üí Brapi com chave
  async function getQuote(symbol){
    // 1) Alpha
    try{
      const resA = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_KEY}`);
      const dataA = await resA.json();
      if(dataA["Global Quote"] && Object.keys(dataA["Global Quote"]).length>0) return {
        symbol:dataA["Global Quote"]["01. symbol"],
        price:dataA["Global Quote"]["05. price"],
        open:dataA["Global Quote"]["02. open"],
        high:dataA["Global Quote"]["03. high"],
        low:dataA["Global Quote"]["04. low"],
        change:dataA["Global Quote"]["10. change percent"]
      };
    }catch(e){}
    // 2) Brapi GitHub gr√°tis
    try{
      const resB = await fetch(`https://brapi.dev/api/quote/${symbol}`);
      const dataB = await resB.json();
      const quote = dataB.results[0];
      if(quote) return {
        symbol:quote.symbol,
        price:quote.regularMarketPrice,
        open:quote.regularMarketOpen,
        high:quote.regularMarketDayHigh,
        low:quote.regularMarketDayLow,
        change:quote.regularMarketChangePercent
      };
    }catch(e){}
    // 3) Brapi com chave
    try{
      const resC = await fetch(`https://brapi.dev/api/quote/${symbol}?apikey=${BRAPI_KEY}`);
      const dataC = await resC.json();
      const quote = dataC.results[0];
      if(quote) return {
        symbol:quote.symbol,
        price:quote.regularMarketPrice,
        open:quote.regularMarketOpen,
        high:quote.regularMarketDayHigh,
        low:quote.regularMarketDayLow,
        change:quote.regularMarketChangePercent
      };
    }catch(e){}
    return null;
  }

  const ativo = await getQuote(query);
  if(!ativo) return alert("Ativo n√£o encontrado ou dados indispon√≠veis!");

  // Cards
  const mainCard = document.createElement('div');
  mainCard.className='card card-wide';
  mainCard.innerHTML=`<strong>${ativo.symbol}</strong><br>${formatBRL(ativo.price)}`;
  userCards.appendChild(mainCard);

  const cardData = [
    ["Abertura",formatBRL(ativo.open)],
    ["M√°xima",formatBRL(ativo.high)],
    ["M√≠nima",formatBRL(ativo.low)],
    ["Varia√ß√£o",formatPerc(ativo.change)]
  ];

  cardData.forEach(([k,v])=>{
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`<strong>${k}</strong><br>${v}`;
    userCards.appendChild(c);
  });

  // Gr√°fico simples de linha com abertura, max, min e fechamento (üìà)
  const ctx = document.getElementById('userChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'line',
    data:{
      labels:['Abertura','M√°x','M√≠n','Fechamento'],
      datasets:[{
        label:ativo.symbol,
        data:[ativo.open,ativo.high,ativo.low,ativo.price],
        borderColor:'green',
        backgroundColor:'rgba(0,255,0,0.2)',
        fill:true
      }]
    },
    options:{responsive:true, plugins:{legend:{display:true}}}
  });
}
</script>

</body>
</html>