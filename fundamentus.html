<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Teste BRAPI - Entrega Real de Dados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: monospace;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}
h1, h2 {
  text-align: center;
}
.ativo {
  background: #020617;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
}
pre {
  background: #020617;
  border: 1px solid #1e293b;
  padding: 12px;
  overflow-x: auto;
  font-size: 13px;
}
.lista {
  columns: 2;
  margin-top: 10px;
}
.badge {
  display: inline-block;
  background: #1e293b;
  padding: 2px 6px;
  border-radius: 4px;
  margin: 2px;
}
.ok {
  color: #22c55e;
}
.err {
  color: #ef4444;
}
.status {
  text-align: center;
  margin-bottom: 20px;
  color: #93c5fd;
}
</style>
</head>
<body>

<h1>ğŸ” Teste BRAPI â€“ Entrega REAL de Dados</h1>
<p style="text-align:center">
PETR4 Â· BBAS3 Â· VALE3 Â· CMIG3 Â·

ITUB4 Â·
BBDC4 Â·
BBAS3 Â·
SANB11 Â·
BPAC11 Â·
B3SA3 Â·
PETR4 Â·
PETR3 Â·
VALE3 Â·
PRIO3 Â·
CSAN3 Â·
UGPA3 Â·
ELET3 Â·
ELET6  Â·
CMIG4 Â·
CPLE6 Â·
EQTL3  Â·
ENBR3 Â·
ABEV3 Â·
LREN3 Â·
MGLU3 Â·
ASAI3 Â·
NTCO3 Â·
VIVA3 Â·
WEGE3 Â·
RAIL3 Â·
EMBR3 Â·
GGBR4 Â·
USIM5 Â·
KLBN11 Â·

HAPV3 Â·
RDOR3 Â·
FLRY3 Â·
COGN3 Â·
YDUQ3 Â·
COGN3



</p>

<div class="status" id="status">Iniciando consultasâ€¦</div>
<div id="resultado"></div>

<script>
const ativosLiquidos = [
  "PETR4","PETR3","COGN3","VALE3","ITUB4","BBDC4","BBAS3","ABEV3","WEGE3",
  "B3SA3","ELET3","ELET6","PRIO3","RAIL3","LREN3","MGLU3","ASAI3",
  "HAPV3","RDOR3","FLRY3","VIVT3","TIMS3","NTCO3","KLBN11","UGPA3",
  "CSAN3","CMIG4","CPLE6","EQTL3","ENBR3","BPAC11","SANB11",
  "GGBR4","USIM5","EMBR3","COGN3","YDUQ3","VIVA3","LWSA3"
];

// â±ï¸ Delay
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ğŸ” Fetch com retry e controle de rate limit
async function fetchBrapiSeguro(ativo, tentativas = 3) {
  for (let i = 1; i <= tentativas; i++) {
    try {
      const res = await fetch(`https://brapi.dev/api/quote/${ativo}`);
      const data = await res.json();

      if (data.results && data.results.length) {
        return data.results[0];
      }
    } catch (e) {}

    console.warn(`Tentativa ${i} falhou para ${ativo}`);
    await sleep(1500);
  }
  return null;
}

async function carregar() {
  const container = document.getElementById("resultado");
  const status = document.getElementById("status");

  for (let i = 0; i < ativos.length; i++) {
    const ativo = ativos[i];
    status.textContent = `Consultando ${ativo} (${i + 1}/${ativos.length})â€¦`;

    const div = document.createElement("div");
    div.className = "ativo";
    div.innerHTML = `<h2>${ativo}</h2><p>Consultando...</p>`;
    container.appendChild(div);

    const obj = await fetchBrapiSeguro(ativo, 3);

    if (!obj) {
      div.innerHTML = `
        <h2>${ativo} <span class="err">âœ–</span></h2>
        <p class="err">Falha ao carregar apÃ³s vÃ¡rias tentativas</p>
      `;
      await sleep(2000);
      continue;
    }

    const keys = Object.keys(obj);

    div.innerHTML = `
      <h2>${ativo} <span class="ok">âœ”</span></h2>
      <p>Total de campos retornados: <strong>${keys.length}</strong></p>

      <h3>ğŸ“‹ Campos entregues</h3>
      <div class="lista">
        ${keys.map(k => `<span class="badge">${k}</span>`).join("")}
      </div>

      <h3>ğŸ“¦ JSON bruto (results[0])</h3>
      <pre>${JSON.stringify(obj, null, 2)}</pre>
    `;

    // â³ pausa antes do prÃ³ximo ativo
    await sleep(2000);
  }

  status.textContent = "âœ” Consultas finalizadas";
}

carregar();
</script>

</body>
</html>